---
title: "Alpha diversity Analysis"
author: "Ã“scar Brochado Kith"
date: "2023-10-24"
output: html_document
runtime: shiny
---

```{r echo=FALSE, warning=FALSE,error=FALSE,message=FALSE}
library(shiny)
library(ggplot2)
library(phyloseq)
library(lme4)
library(rstatix)
library(DT)
```

```{r echo=FALSE}

fileInput("file",label="select ypur phyloseq object",accept=".rds")
selectInput("data","Alpha diversity index",c("Chao1","Shannon","Simpson"))
selectInput("variable",label="Select grouping varable","")
selectInput("data2",label="Groups to compare","",multiple=TRUE)

loaded_data <- reactiveVal(NULL)
observeEvent(input$file, {
    req(input$file)
    
    datos <- readRDS(input$file$datapath)
    
    loaded_data(datos)
    
    col_options <- colnames(as.data.frame(sample_data(datos)))
    
    updateSelectInput(session, "variable", choices = col_options)
  })

observeEvent(input$variable, {
    req(loaded_data())

    datos2 <- readRDS(input$file$datapath)

    col_options2 <- unique(data.frame(sample_data(datos2))[,input$variable])

    updateSelectInput(session, "data2", choices =col_options2)
})
```
# Boxplot
```{r echo=FALSE}

renderPlot({
    ps<-readRDS(input$file$datapath)
    alpha_div_ps<-estimate_richness(ps,measures=c("Chao1","Shannon","Simpson"))
    alpha_div_ps$group<-as.factor(data.frame(sample_data(ps))[,input$variable])
    alpha_div_ps_mod<-alpha_div_ps[alpha_div_ps$group==input$data2,]


    ggplot(alpha_div_ps_mod,aes(x=group,y=get(input$data)))  +
    geom_boxplot(aes(colour=group)) + geom_jitter(width = 0.2,aes(colour=group))
})
```

# Kruskal-Wallis
```{r echo=FALSE}

renderDataTable({
    ps<-readRDS(input$file$datapath)
    alpha_div_ps<-estimate_richness(ps,measures=c("Chao1","Shannon","Simpson"))
    alpha_div_ps$group<-as.factor(data.frame(sample_data(ps))[,input$variable])
    alpha_div_ps_mod<-alpha_div_ps[alpha_div_ps$group==input$data2,]

    dunn_test(alpha_div_ps[alpha_div_ps$group%in%input$data2,],as.formula(paste0(input$data,"~","group")),p.adjust.method = "fdr")
})
```

# Logistic regresion model
```{r echo=FALSE}

renderDataTable({
    ps<-readRDS(input$file$datapath)
    alpha_div_ps<-estimate_richness(ps,measures=c("Chao1","Shannon","Simpson"))
    alpha_div_ps$group<-as.factor(data.frame(sample_data(ps))[,input$variable])
    alpha_div_ps_mod<-alpha_div_ps[alpha_div_ps$group==input$data2,]

    as.data.frame(summary(lm(as.formula(paste0(input$data,"~","group")),data=alpha_div_ps[alpha_div_ps$group%in%input$data2,]))$coefficients)
})
```
